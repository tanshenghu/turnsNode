<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1">
    <meta name="Keywords" content="">
    <meta name="Description" content="">
    <meta name="Author" content="TanShenghu">
    <title>微型数据库操作</title>
    <style>*{margin:0;padding:0;}body{font:12px/1.5 tahoma,Microsoft YaHei,"\5FAE\8F6F\96C5\9ED1";color:#666;padding:20px;}dl{border:1px solid #ccc;padding:15px;margin-bottom:10px;}
    #tableList dt{font-weight:bold;font-size:28px;color:#444;line-height:50px;text-indent:5px;text-shadow:1px 1px 1px orange;}#tableList th,#tableList td{padding:5px 3px;}#tableList thead label{color:green;padding-left:7px}#tableList .disabled{background-color:#ccc;}
    #tableList .j-addField,#tableList .j-addLineData,#tableList .j-removeField,#tableList .j-saveLineData{border:1px solid #ccc;background:orange;color:white;border-radius:3px;height:32px;width:120px;margin-right:10px;}#tableList .handBtn-box{padding-top:15px;}</style>
</head>
<body>
    <div>{{content}}</div>
    <script>
    !function(){
        
        var tableContainer = window.tableList;
        var el = function( el ){return document.createElement(el)};
        var toParams = function( o ){var p='';for(var i in o){p+='&'+i+'='+o[i]};return p.slice(1);};
        var getTable = function(){
            
            xhr('get', 'database_getTableNames.json', {}, function( res ){
                
                var tblNameHtml = '';
                res.data.forEach(function( v ){
                    var tn = (Object.keys( v )+'').replace(/,?fields,?/g, ''),
                    fields = '<thead><tr>' + v.fields.map(function(f){return '<th field-name="'+f.name+'"><cite>'+f.name+'</cite><label>'+f.type+'</label></th>'}).join('') + '</tr></thead>',
                    tbody  = '';
                    
                    v[ tn ].forEach(function( vv, ii ){
                        
                        tbody += '<tr class="exist">'+ v.fields.map(function(f){return '<td><div contenteditable="false" class="editor">'+ vv[f.name] +'</div></td>'}).join('') +'</tr>';
                        
                    })
                    tableContainer.innerHTML = tblNameHtml += '<dl><dt><div>'+ tn +'</div></dt><dd><table border="1" width="100%">'+ fields + tbody +'</table><div class="handBtn-box"><button class="j-addField">新增字段</button><button class="j-addLineData">新增数据</button><button class="j-removeField">删除字段</button></div></dd></dl>';
                })
                tableContainer.innerHTML = tblNameHtml;
                
            })
            
        },
        xhr = function( type, url, params, callback ){
            type = type.toUpperCase();
            var _body = null;
            if( type=='GET' ){
                url += ( url.indexOf('?')>-1 ? '&' : '?' ) + toParams( params );
            }else{
                _body = toParams( params );
            }
            
            url = url.replace(/[\?\&]$/, '');
            
            fetch(url, {method:type, headers:{Accept: '*/*',"Content-Type": type=='POST'?"application/x-www-form-urlencoded":"application/json"},body:_body})
            .then(function( res ){
                return res.json();
            })
            .then(function( res ){
                callback( res );
            })
        },
        handEvt = function(){
            
            var bindEvt = function( ev ){
                
                var target = ev.target,
                clsName    = target.className,
                tbody      = target.parentNode.previousSibling.querySelector('tbody');
                if( clsName.indexOf('j-addField')>-1 ){ // 新增字段
                    
                    addField.call( target, target, tbody, ev );
                    
                }else if( clsName.indexOf('j-removeField')>-1 ){ // 删除某字段
                    
                    removeField.call( target, target, tbody, ev );
                    
                }else if( clsName.indexOf('j-addLineData')>-1 ){ // 新增行数据
                    
                    if( tbody.innerHTML.indexOf('newLine')>-1 ){
                        alert( '请先保存新增行后再添加!' );
                        return false;
                    }
                    addLineData.call( target, target, tbody, ev );
                    
                }else if( clsName.indexOf('j-saveLineData')>-1 ){ // 保存行数据
                    
                    saveLineData.call( target, target, tbody, ev );
                    
                }
                
            }
            tableContainer.addEventListener('click', bindEvt, false);
            
            tableContainer.addEventListener('blur', saveFieldToData, false);
            
        },
        addField = function( target, tbody, ev ){
            var newFieldName = prompt( '请输入新增加字段名称' );
            if( newFieldName && newFieldName.trim() ){
                
                xhr('get', 'database_addField.json', {name: newFieldName}, function( res ){
                    if( res.success ){
                        location.reload();
                    }else{
                        alert( res.message );
                    }
                })
                
            }
        },
        removeField = function( target, tbody, ev ){
            
            var delFieldName = prompt( '请输入要删除的字段名称' );
            if( delFieldName && delFieldName.trim() && confirm('您确定要删除"'+ delFieldName.trim() +'"字段?') ){
                
                xhr('get', 'database_removeField.json', {name: delFieldName}, function( res ){
                    if( res.success ){
                        location.reload();
                    }else{
                        alert( res.message );
                    }
                })
                
            }
            
        },
        addLineData = function( target, tbody, ev ){
            
            var newLine = el('tr');
            newLine.className = 'newLine';
            newLine.innerHTML = '<td><div contenteditable="true"></div></td>'.repeat( tbody.querySelectorAll('tr:first-child>td').length ).replace('<td', '<td class="disabled"').replace('contenteditable="true"', 'contenteditable="false"');
            tbody.appendChild( newLine );
            
            target.innerHTML = '保存数据';
            target.className = 'j-saveLineData';
            
        },
        saveLineData = function( target, tbody, ev ){
            
            var ths = tbody.previousSibling.querySelectorAll('th');
            
            if( confirm('您确定要保存最后一行新增数据吗?') ){
                
                var params = {};
                var ts = tbody.querySelector('tr.newLine:last-child').querySelectorAll('[contenteditable]');
                for(var i=0,l=ts.length; i<l; i++){
                    params[ ths[i].getAttribute('field-name') ] = ts[i].innerText || ts[i].textContent;
                }
                
                xhr('post', 'database_saveLineData.json', params, function( res ){
                    
                    if( res.success ){
                        location.reload();
                    }else{
                        alert( res.message );
                    }
                    
                })
                
            }
            
        },
        saveFieldToData = function( ev ){
            
            if( ev.target.className=='editor' ){
                alert(8888)
            }
            
        }
        
        // 获取表 数据
        getTable();
        // 事件操作
        handEvt();
        
    }()
    </script>
</body>
</html>